# Руководство по добавлению интерактивности к блокам DSP Flow Editor

## Реализованные возможности

✅ **Редактирование параметров блоков** - кнопка настроек на каждом блоке
✅ **Блок "Аудио-файл"** - загрузка WAV файлов
✅ **Редактирование генераторов** - изменение частоты и амплитуды
✅ **Редактирование фильтров** - изменение частоты среза и порядка

## Структура файлов

```
src/
├── components/
│   └── dsp/
│       ├── BlockNode/
│       │   ├── BlockNode.jsx     [ОБНОВЛЕН]
│       │   ├── BlockNode.css     [ОБНОВЛЕН]
│       │   └── index.js
│       └── ParamsEditor/         [НОВЫЙ]
│           ├── ParamsEditor.jsx
│           ├── ParamsEditor.css
│           └── index.js
└── utils/
    └── constants.js              [ТРЕБУЕТСЯ ОБНОВИТЬ]
```

## Шаги по интеграции

### 1. Скопировать новые файлы

Скопируйте следующие файлы в ваш проект:

- `/home/claude/src/components/dsp/BlockNode/BlockNode.jsx`
- `/home/claude/src/components/dsp/BlockNode/BlockNode.css`
- `/home/claude/src/components/dsp/ParamsEditor/ParamsEditor.jsx`
- `/home/claude/src/components/dsp/ParamsEditor/ParamsEditor.css`
- `/home/claude/src/components/dsp/ParamsEditor/index.js`

### 2. Обновить constants.js

Добавьте в `src/utils/constants.js`:

#### В DSP_BLOCK_TYPES:
```javascript
AUDIO_FILE: 'Аудио-файл',
```

#### В DEFAULT_BLOCK_PARAMS:
```javascript
[DSP_BLOCK_TYPES.AUDIO_FILE]: {
    audioFile: null,
    sampleRate: 48000,
    channels: 'mono',
},
```

#### В BLOCK_SIGNAL_CONFIG:
```javascript
'Аудио-файл': { input: null, output: SIGNAL_TYPES.REAL },
```

#### В DSP_ICONS:
```javascript
'Аудио-файл': 'audio_file',
```

#### В DSP_GROUPS (в группу generators):
```javascript
{
    id: 'audio-file',
    name: DSP_BLOCK_TYPES.AUDIO_FILE,
    icon: DSP_ICONS['Аудио-файл'],
    description: 'Загрузка WAV файла',
}
```

### 3. Обновить DSPEditor.jsx

В функции `onDrop`, обновите создание нового узла:

```javascript
const newNode = {
    id: generateNodeId(),
    type: 'block',
    position,
    data: {
        label: blockType,
        blockType,
        params: getDefaultParams(blockType),
        signalConfig: signalConfig,
        // ДОБАВИТЬ эту функцию:
        onParamsUpdate: (newParams) => {
            setNodes((nds) =>
                nds.map((node) => {
                    if (node.id === newNode.id) {
                        return {
                            ...node,
                            data: {
                                ...node.data,
                                params: newParams
                            }
                        };
                    }
                    return node;
                })
            );
        }
    },
};
```

### 4. Обновить ValidationService

Добавьте валидацию для блока "Аудио-файл" в `src/services/validationService.js`:

```javascript
'Аудио-файл': (p) => {
    const errors = [];
    if (!p.audioFile) {
        errors.push('Необходимо выбрать аудио-файл');
    }
    if (p.sampleRate && (p.sampleRate < 8000 || p.sampleRate > 192000)) {
        errors.push('Частота дискретизации должна быть от 8000 до 192000 Гц');
    }
    return errors;
}
```

## Использование

### Для пользователя:

1. **Добавить блок на холст** - перетащите блок из панели слева
2. **Открыть настройки** - нажмите кнопку ⚙️ на блоке
3. **Изменить параметры** - отредактируйте нужные значения
4. **Для блока "Аудио-файл"** - нажмите "Выбрать WAV файл"
5. **Применить изменения** - нажмите "Применить"

### Поддерживаемые блоки:

- ✅ **Аудио-файл** - выбор WAV файла, частота дискретизации, каналы
- ✅ **Входной сигнал** - частота, амплитуда, тип сигнала
- ✅ **Генераторы (синус/косинус)** - частота, амплитуда, фаза
- ✅ **Все фильтры** - порядок, частота среза
- ✅ **Полосовой фильтр** - порядок, нижняя и верхняя частота

## Особенности реализации

### ParamsEditor

- **Модальное окно** для редактирования
- **Динамическая генерация полей** на основе типа блока
- **Валидация параметров** перед сохранением
- **Поддержка файлов** - специальный интерфейс для загрузки WAV
- **Адаптивный дизайн** - работает на мобильных устройствах

### BlockNode

- **Кнопка настроек** в заголовке блока
- **Индикатор файла** - показывает имя загруженного файла
- **Обновление в реальном времени** - изменения видны сразу
- **Обратная совместимость** - работает со старыми схемами

### Валидация

- Проверка диапазонов значений
- Проверка формата файлов (только .WAV)
- Проверка логических ограничений (например, нижняя частота < верхней)

## Дальнейшее развитие

### Возможные улучшения:

1. **WAV парсинг** - извлечение метаданных из файла
2. **Предпросмотр аудио** - волновая форма в ParamsEditor
3. **Пресеты параметров** - сохранение часто используемых настроек
4. **Горячие клавиши** - быстрое открытие настроек (например, двойной клик)
5. **История изменений** - Undo/Redo для параметров
6. **Копирование параметров** - между блоками одного типа

## Тестирование

Протестируйте следующие сценарии:

- [ ] Открытие ParamsEditor кликом на кнопку
- [ ] Изменение параметров и сохранение
- [ ] Загрузка WAV файла
- [ ] Валидация некорректных значений
- [ ] Отмена изменений
- [ ] Работа с несколькими блоками одновременно
- [ ] Сохранение и загрузка схемы с измененными параметрами

## Поддержка

Если возникнут вопросы или проблемы, проверьте:

1. Все ли файлы скопированы в правильные директории
2. Обновлены ли все необходимые импорты
3. Установлены ли все зависимости (npm install)
4. Нет ли ошибок в консоли браузера

---

**Версия**: 1.0.0  
**Дата**: 2026-02-07  
**Автор**: Claude (Anthropic)
